<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>039 Photos (Developed by J.A.R.V.I.S)</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<style>
  :root {
    --accent: #0078ff;
    --bg: #f4f6fb;
    --text: #222;
  }
  body {
    font-family: 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    margin: 0;
    color: var(--text);
  }
  header {
    background: linear-gradient(90deg, var(--accent), #00c6ff);
    color: white;
    padding: 16px;
    text-align: center;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .tabs {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 14px;
    background: #fff;
    border-bottom: 1px solid #e6e6e6;
  }
  .tab {
    padding: 8px 16px;
    border-radius: 20px;
    background: #f1f3f6;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }
  .tab:hover { background: #e7ebf0; }
  .tab.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  main {
    max-width: 1080px;
    margin: 20px auto;
    padding: 0 12px;
  }
  .upload-card {
    background: white;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    text-align: center;
  }
  input[type=file] {
    margin: 10px 0;
  }
  button.primary {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 8px 14px;
    font-weight: 600;
    cursor: pointer;
  }
  button.primary:hover {
    background: #006ae0;
  }
  #progressList {
    margin-top: 10px;
    text-align: left;
  }
  .progress-row {
    background: #fff;
    padding: 8px;
    border-radius: 8px;
    margin: 8px 0;
    box-shadow: 0 3px 8px rgba(0,0,0,0.04);
  }
  .progress-bar {
    height: 8px;
    background: #eee;
    border-radius: 999px;
    overflow: hidden;
    margin: 6px 0;
  }
  .progress-fill {
    height: 100%;
    background: #10b981;
    width: 0%;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
    margin-top: 22px;
  }
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    overflow: hidden;
    transition: transform 0.2s ease;
  }
  .card:hover { transform: scale(1.02); }
  .card img, .card video {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }
  .meta {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    font-size: 12px;
    color: #666;
    align-items: center;
  }
  .delete-btn {
    background: #ef4444;
    color: #fff;
    border: none;
    padding: 5px 8px;
    border-radius: 6px;
    cursor: pointer;
  }
  @media(max-width:600px){
    .card img, .card video{ height: 140px; }
  }
</style>
</head>
<body>

<header>ðŸ“¸ 039 Photos (Developed by J.A.R.V.I.S)</header>

<div class="tabs">
  <div class="tab active" data-tab="all" onclick="setTab('all')">All Media</div>
  <div class="tab" data-tab="photos" onclick="setTab('photos')">Photos</div>
  <div class="tab" data-tab="videos" onclick="setTab('videos')">Videos</div>
</div>

<main>
  <div class="upload-card">
    <h3>Upload Photos or Videos</h3>
    <input id="fileInput" type="file" accept="image/*,video/*" multiple />
    <br>
    <button class="primary" onclick="startUpload()">Upload</button>
    <div id="status" style="margin-top:6px;color:#555;"></div>
    <div id="progressList"></div>
  </div>

  <div id="gallery" class="grid"></div>
</main>

<script>
/* ------------------ CONFIG ------------------ */
const SUPABASE_URL = "https://cksuswghafnksktbkbvg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrc3Vzd2doYWZua3NrdGJrYnZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MzU4NjAsImV4cCI6MjA3NzMxMTg2MH0.xvlF24-bse44uqnc35ew4KMqw_qIZYcIedT6zIhQXCM";
const BUCKET = "photos";
const ADMIN_PASSWORD = "harsha@112";
/* -------------------------------------------- */

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentTab = 'all';

function setTab(tab){
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
  renderGallery();
}

/* Upload with Progress */
function uploadXHR(file, path, onProgress){
  return new Promise((resolve,reject)=>{
    const url = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent(BUCKET)}/${encodeURIComponent(path)}`;
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', url);
    xhr.setRequestHeader('Authorization', 'Bearer ' + SUPABASE_KEY);
    xhr.setRequestHeader('apikey', SUPABASE_KEY);
    if (file.type) xhr.setRequestHeader('Content-Type', file.type);
    xhr.upload.onprogress = e=>{
      if(e.lengthComputable && onProgress){
        onProgress(e.loaded, e.total);
      }
    };
    xhr.onload = ()=> xhr.status>=200 && xhr.status<300 ? resolve() : reject(xhr.responseText);
    xhr.onerror = ()=> reject("Upload failed");
    xhr.send(file);
  });
}

async function startUpload(){
  const input = document.getElementById('fileInput');
  const files = Array.from(input.files);
  if(!files.length) return alert('Select files to upload');

  document.getElementById('status').textContent = `Uploading ${files.length} file(s)...`;
  const progressList = document.getElementById('progressList');
  progressList.innerHTML = '';

  const tasks = files.map((file, i)=>{
    const id = `p-${i}`;
    const row = document.createElement('div');
    row.className='progress-row';
    row.innerHTML = `
      <div>${file.name}</div>
      <div class="progress-bar"><div class="progress-fill" id="${id}"></div></div>
    `;
    progressList.appendChild(row);

    const name = `${Date.now()}_${Math.random().toString(36).slice(2,8)}_${file.name}`;
    return uploadXHR(file, name, (loaded,total)=>{
      document.getElementById(id).style.width = (loaded/total*100)+'%';
    });
  });

  await Promise.all(tasks);
  document.getElementById('status').textContent = 'All uploads complete!';
  input.value='';
  renderGallery();
}

/* Load and Display Media */
async function listAllObjects(){
  const { data, error } = await supabase.storage.from(BUCKET).list('', { limit: 1000 });
  return data || [];
}

function getPublicUrl(path){
  const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
  return data.publicUrl;
}

async function renderGallery(){
  const container = document.getElementById('gallery');
  container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666;">Loading...</p>';
  const files = await listAllObjects();
  container.innerHTML = '';

  const filtered = files.filter(f=>{
    if(currentTab==='all') return true;
    const isVideo = /\.(mp4|mov|avi|webm|mkv)$/i.test(f.name);
    return currentTab==='videos' ? isVideo : !isVideo;
  });

  if(!filtered.length){
    container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#777;">No media found.</p>';
    return;
  }

  filtered.sort((a,b)=> new Date(b.updated_at||0) - new Date(a.updated_at||0));

  for(const f of filtered){
    const url = getPublicUrl(f.name);
    const card = document.createElement('div');
    card.className='card';

    if(/\.(mp4|mov|avi|webm|mkv)$/i.test(f.name)){
      const v = document.createElement('video');
      v.src=url; v.controls=true;
      card.appendChild(v);
    }else{
      const img = document.createElement('img');
      img.src=url;
      card.appendChild(img);
    }

    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = `<span>${f.name}</span>`;
    const del = document.createElement('button');
    del.className='delete-btn';
    del.textContent='Delete';
    del.onclick = async()=>{
      const pass = prompt('Enter admin password:');
      if(pass===ADMIN_PASSWORD){
        await supabase.storage.from(BUCKET).remove([f.name]);
        alert('Deleted successfully');
        renderGallery();
      }else if(pass!==null){
        alert('Wrong password');
      }
    };
    meta.appendChild(del);
    card.appendChild(meta);
    container.appendChild(card);
  }
}

/* Initialize */
setTab('all');
</script>

</body>
</html>
