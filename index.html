<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>039 Photos (Developed by J.A.R.V.I.S)</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  :root{
    --bg:#071225; --card:rgba(6,18,30,0.6);
    --jarvis:#00f0ff; --jarvis2:#00c6ff; --jarvis3:#6b00ff;
    --text:#d8f9ff; --muted:rgba(216,249,255,0.7);
    --danger:#ff6363; --success:#10b981;
  }
  html,body{height:100%;margin:0;background:#000;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,-apple-system}
  /* background */
  #bgwrap{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;background:linear-gradient(180deg,#000010 0%, #00061a 50%, #001428 100%);}
  .bg-grid{position:absolute;inset:0;opacity:0.08;background-image:
    radial-gradient(circle at 10% 10%, rgba(0,198,255,0.65) 0px, rgba(0,0,0,0) 60px),
    radial-gradient(circle at 90% 80%, rgba(107,0,255,0.6) 0px, rgba(0,0,0,0) 100px),
    linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
    background-size: 500px 500px, 700px 700px, 100% 100%;}
  .scanline{position:absolute;left:-50%;right:-50%;height:2px;top:-30%;background:
    linear-gradient(90deg, rgba(0,255,255,0) 0%, rgba(0,255,255,0.12) 45%, rgba(255,255,255,0.9)50%, rgba(0,255,255,0.12)55%, rgba(0,255,255,0)100%);
    filter:blur(6px); animation:scan 16s linear infinite;opacity:0.07}
  @keyframes scan{0%{transform:translateY(-40vh)}50%{transform:translateY(120vh)}100%{transform:translateY(240vh)}}
  .particles {position:absolute;inset:-10%;z-index:0;pointer-events:none;opacity:0.12;background:
    radial-gradient(circle at 10% 10%, rgba(0,198,255,0.08) 0 2px, transparent 2px),
    radial-gradient(circle at 30% 80%, rgba(107,0,255,0.06) 0 2px, transparent 2px),
    radial-gradient(circle at 70% 30%, rgba(0,255,200,0.06) 0 2px, transparent 2px);
    background-size: 40px 40px, 60px 60px, 50px 50px; animation: drift 14s linear infinite;}
  @keyframes drift{0%{transform:translateY(0)}50%{transform:translateY(18px)}100%{transform:translateY(0)}}
  .glow{position:absolute;border-radius:50%;width:900px;height:900px;filter:blur(140px);opacity:0.12}
  .g1{left:-18%;top:-34%;background:radial-gradient(circle at 30% 30%, rgba(107,0,255,0.95) 0%, rgba(0,198,255,0.12) 18%, rgba(0,0,0,0) 60%);animation:float1 14s ease-in-out infinite}
  .g2{right:-26%;top:6%;background:radial-gradient(circle at 70% 60%, rgba(0,198,255,0.95) 0%, rgba(107,0,255,0.08) 18%, rgba(0,0,0,0) 60%);animation:float2 18s ease-in-out infinite}
  @keyframes float1{0%{transform:translateY(0)}50%{transform:translateY(18px)}100%{transform:translateY(0)}}
  @keyframes float2{0%{transform:translateY(0)}50%{transform:translateY(-22px)}100%{transform:translateY(0)}}

  .app{position:relative;z-index:3;max-width:1180px;margin:28px auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px);box-shadow:0 8px 40px rgba(2,6,23,0.6)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:10px;display:grid;place-items:center;font-weight:800;color:#001018;background:linear-gradient(135deg,var(--jarvis3),var(--jarvis2));box-shadow:0 6px 18px rgba(0,198,255,0.12)}
  h1{margin:0;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .tabs{display:flex;gap:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .tab{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer;font-weight:700;color:var(--text);transition:all .12s}
  .tab.active{background:linear-gradient(90deg, rgba(0,198,255,0.12), rgba(107,0,255,0.12));box-shadow:0 6px 20px rgba(0,198,255,0.06);border-color:rgba(0,198,255,0.35)}
  .panel{margin-top:16px;background:var(--card);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
  .file-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .choose{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:linear-gradient(90deg, rgba(0,198,255,0.12), rgba(107,0,255,0.12));border:1px solid rgba(0,198,255,0.16);cursor:pointer;font-weight:800;color:#001018}
  input[type=file]{display:none}
  .btn{padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,var(--jarvis3),var(--jarvis2));color:#001018;border:none;cursor:pointer;font-weight:900;box-shadow:0 8px 30px rgba(0,198,255,0.12)}
  .uploader-name{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
  .status{color:var(--muted);font-weight:700}
  #progressList{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .progress-row{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.16));border:1px solid rgba(255,255,255,0.02)}
  .p-title{font-weight:800}
  .pbar{height:8px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:6px}
  .pfill{height:100%;width:0%;background:linear-gradient(90deg,var(--jarvis),var(--jarvis2));transition:width .08s linear}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:18px}
  .card{border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.16));overflow:hidden;border:1px solid rgba(0,198,255,0.06);box-shadow:0 10px 40px rgba(2,6,23,0.6);position:relative;transition:transform .12s}
  .card:hover{transform:translateY(-6px)}
  .media{height:180px;background:rgba(0,0,0,0.08);display:block}
  .media img,.media video{width:100%;height:100%;object-fit:cover;display:block}
  .meta{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;color:var(--muted);font-size:13px}
  .fname{font-weight:800;color:var(--text);max-width:70%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .fmeta{font-size:12px;opacity:0.8}
  .neon{position:absolute;inset:6px;border-radius:10px;pointer-events:none;border:1px solid rgba(0,198,255,0.06);box-shadow:inset 0 0 10px rgba(0,198,255,0.03)}
  .delete{padding:6px 10px;border-radius:8px;border:0;background:linear-gradient(90deg,#ff6363,#ff8a4d);color:white;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(255,99,99,0.12)}
  .u-list{display:flex;flex-direction:column;gap:8px;padding:8px}
  .u-item{padding:8px 10px;border-radius:8px;background:linear-gradient(90deg, rgba(0,198,255,0.08), rgba(107,0,255,0.06));cursor:pointer;font-weight:800;color:#001018;border:1px solid rgba(0,198,255,0.16)}
  #loader{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8));z-index:9}
  .ring{width:96px;height:96px;border-radius:50%;border:6px solid rgba(0,0,0,0.18);position:relative;display:grid;place-items:center}
  .ring:before{content:"";position:absolute;inset:-6px;border-radius:50%;border:6px solid transparent;border-top-color:var(--jarvis);animation:spin 1.8s linear infinite}
  .ring:after{content:"";position:absolute;inset:-16px;border-radius:50%;border:4px solid transparent;border-bottom-color:var(--jarvis3);filter:blur(6px);animation:spin 3s linear infinite}
  .loader-text{margin-top:12px;color:var(--muted);font-weight:800}
  @keyframes spin{to{transform:rotate(360deg)}}
  .music-toggle{padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,var(--jarvis2),var(--jarvis));color:#001018;font-weight:800;border:0;cursor:pointer}
  @media(max-width:720px){ .media{height:140px} .brand h1{font-size:16px} .logo{width:44px;height:44px} }
</style>
</head>
<body>
  <!-- BACKGROUND -->
  <div id="bgwrap" aria-hidden="true">
    <div class="bg-grid"></div>
    <div class="particles"></div>
    <div class="glow g1"></div>
    <div class="glow g2"></div>
    <div class="scanline"></div>
  </div>

  <!-- Loader (shows until gallery initialized) -->
  <div id="loader" role="status" aria-live="polite">
    <div style="text-align:center">
      <div class="ring"></div>
      <div class="loader-text">Initializing J.A.R.V.I.S. Interface...</div>
    </div>
  </div>

  <!-- APP -->
  <div class="app" role="application" aria-label="039 Photos app">
    <header>
      <div class="brand">
        <div class="logo">039</div>
        <div>
          <h1>039 Photos <span style="font-weight:600;color:var(--jarvis2);font-size:12px">— Developed by J.A.R.V.I.S</span></h1>
          <div class="sub">Upload • Share • Manage (admin delete)</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div class="tabs" role="tablist" aria-label="Main tabs">
          <button class="tab active" data-tab="all" onclick="setTab('all')">All Media</button>
          <button class="tab" data-tab="photos" onclick="setTab('photos')">Photos</button>
          <button class="tab" data-tab="videos" onclick="setTab('videos')">Videos</button>
          <button class="tab" data-tab="uploaders" onclick="setTab('uploaders')">Uploaded Names</button>
        </div>
        <button class="music-toggle" id="musicBtn" title="Toggle music" onclick="toggleMusic()">Loading…</button>
      </div>
    </header>

    <section class="panel">
      <div class="panel" style="padding:14px">
        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;align-items:center">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <label for="fileInput" class="choose" title="Choose files">
              <div class="ic">+</div>
              <div>Choose Files</div>
            </label>
            <input id="fileInput" type="file" accept="image/*,video/*" multiple />
            <input id="uploaderName" class="uploader-name" placeholder="Your name (shown to others)" />
            <button class="btn" onclick="startUpload()">Upload</button>
          </div>

          <div class="status" id="status">Ready — anyone can upload</div>
        </div>

        <div id="progressList" aria-live="polite"></div>
      </div>

      <div id="gallerySection">
        <div id="gallery" class="grid" aria-live="polite"></div>
      </div>

      <div id="uploaderSection" style="display:none;margin-top:12px">
        <div class="panel">
          <h3 style="margin:0 0 8px 0;color:var(--jarvis2)">Uploaded Names</h3>
          <div id="uploaderList" class="u-list"></div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ------------------ CONFIG (same as you provided) ------------------ */
const SUPABASE_URL = "https://cksuswghafnksktbkbvg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrc3Vzd2doYWZua3NrdGJrYnZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MzU4NjAsImV4cCI6MjA3NzMxMTg2MH0.xvlF24-bse44uqnc35ew4KMqw_qIZYcIedT6zIhQXCM";
const BUCKET = "photos";
const ADMIN_PASSWORD = "harsha@112";
/* ------------------------------------------------- */

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentTab = 'all';
let galleryFilterUploader = null;

/* Helper human size */
function humanSize(bytes){
  if(!bytes && bytes!==0) return '';
  if(bytes < 1024) return bytes + ' B';
  if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(2) + ' MB';
}

/* TABS */
function setTab(tab){
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
  document.getElementById('gallery').style.display = (tab==='uploaders') ? 'none' : 'grid';
  document.getElementById('uploaderSection').style.display = (tab==='uploaders') ? 'block' : 'none';
  if(tab!=='uploaders') galleryFilterUploader = null;
  renderGallery();
  if(tab==='uploaders') renderUploaderList();
}

/* ---------- Upload with XHR (progress) ---------- */
function uploadXHR(file, path, onProgress){
  return new Promise((resolve,reject)=>{
    const url = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent(BUCKET)}/${encodeURIComponent(path)}`;
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', url, true);
    xhr.setRequestHeader('Authorization', 'Bearer ' + SUPABASE_KEY);
    xhr.setRequestHeader('apikey', SUPABASE_KEY);
    if(file.type) xhr.setRequestHeader('Content-Type', file.type);
    xhr.upload.onprogress = (e) => { if(e.lengthComputable && onProgress) onProgress(e.loaded, e.total); };
    xhr.onreadystatechange = () => {
      if(xhr.readyState===4){
        if(xhr.status>=200 && xhr.status<300) resolve(true);
        else reject(new Error('Upload failed ' + xhr.status + ': ' + xhr.responseText));
      }
    };
    xhr.onerror = ()=> reject(new Error('Network error'));
    xhr.send(file);
  });
}

/* Start upload: include uploader name in filename prefix so we can show it later */
async function startUpload(){
  const input = document.getElementById('fileInput');
  const files = Array.from(input.files || []);
  const uploaderRaw = (document.getElementById('uploaderName').value || 'Anonymous').trim() || 'Anonymous';
  if(!files.length) return alert('Select file(s) first');

  document.getElementById('status').innerText = `Uploading ${files.length} file(s)...`;
  const plist = document.getElementById('progressList');
  plist.innerHTML = '';

  // limit concurrency to 3
  const concurrency = 3;
  let idx = 0;
  const results = [];

  async function worker(i){
    while(true){
      const fileIndex = idx++;
      if(fileIndex >= files.length) break;
      const file = files[fileIndex];

      const row = document.createElement('div'); row.className='progress-row';
      row.innerHTML = `<div class="p-title">${file.name} <span style="color:var(--jarvis2);font-weight:900">(${humanSize(file.size)})</span></div>
        <div class="pbar"><div id="pf-${fileIndex}" class="pfill"></div></div>`;
      plist.appendChild(row);

      const safeUploader = uploaderRaw.replace(/[^a-zA-Z0-9_\-]/g,'_').slice(0,40) || 'Anonymous';
      const unique = `${safeUploader}__${Date.now()}_${Math.random().toString(36).slice(2,8)}_${file.name.replace(/\s+/g,'_')}`;

      try{
        await uploadXHR(file, unique, (loaded, total) => {
          const pct = Math.round((loaded/total)*100);
          const el = document.getElementById(`pf-${fileIndex}`);
          if(el) el.style.width = pct + '%';
        });
        results.push({ ok:true, name: unique, orig:file.name, size:file.size, uploader:safeUploader });
      } catch(err){
        results.push({ ok:false, err: err.message, name: unique, orig:file.name });
      }
    }
  }

  // spawn workers
  await Promise.all(Array.from({length: Math.min(concurrency, files.length)}).map((_,i)=> worker(i)));

  const failed = results.filter(r => !r.ok);
  if(failed.length){
    console.error('Failed:', failed);
    alert(`${failed.length} file(s) failed to upload. See console.`);
    document.getElementById('status').innerText = `${failed.length} file(s) failed`;
  } else {
    document.getElementById('status').innerText = 'All uploads complete!';
  }
  input.value = '';
  // after upload, refresh gallery (uploader names preserved in filename)
  await renderGallery();
}

/* ---------- List & render gallery ---------- */
async function listAllObjects(){
  try{
    const { data, error } = await supabase.storage.from(BUCKET).list('', { limit: 1000 });
    if(error){ console.error('List error', error); return []; }
    return data || [];
  } catch(e){
    console.error('List exception', e); return [];
  }
}

function getPublicUrl(path){
  const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
  return (data && data.publicUrl) ? data.publicUrl : null;
}

function parseUploaderFromName(filename){
  const parts = filename.split('__');
  if(parts.length < 2) return 'Unknown';
  return parts[0] || 'Unknown';
}

function parseOriginalName(filename){
  const parts = filename.split('__');
  if(parts.length < 2) return filename;
  return parts.slice(1).join('__');
}

function formatDate(ts){
  if(!ts) return '';
  return new Date(ts).toLocaleString();
}

async function renderGallery(){
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--muted)">Loading...</div>`;
  const objs = await listAllObjects();
  gallery.innerHTML = '';
  if(!objs.length){
    gallery.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--muted)">No media yet — upload files to start.</div>`;
    return;
  }

  // filter by tab
  let filtered = objs.filter(o => {
    if(currentTab === 'all') return true;
    const isVideo = /\.(mp4|mov|avi|webm|mkv)$/i.test(o.name);
    if(currentTab === 'videos') return isVideo;
    if(currentTab === 'photos') return !isVideo;
    return true;
  });

  // if galleryFilterUploader set, filter by uploader
  if(galleryFilterUploader){
    filtered = filtered.filter(o => parseUploaderFromName(o.name) === galleryFilterUploader);
  }

  // newest first
  filtered.sort((a,b) => (new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at)));

  for(const obj of filtered){
    try{
      const url = getPublicUrl(obj.name);
      if(!url) continue;
      const card = document.createElement('div'); card.className='card';
      const media = document.createElement('div'); media.className='media';
      if(/\.(mp4|mov|avi|webm|mkv)$/i.test(obj.name)){
        const v = document.createElement('video'); v.src = url; v.controls = true; v.preload='metadata'; media.appendChild(v);
      } else {
        const img = document.createElement('img'); img.src = url; img.loading='lazy'; media.appendChild(img);
      }
      card.appendChild(media);

      const neon = document.createElement('div'); neon.className='neon'; card.appendChild(neon);

      const meta = document.createElement('div'); meta.className='meta';
      const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
      const fname = document.createElement('div'); fname.className='fname'; fname.title = parseOriginalName(obj.name); fname.textContent = parseOriginalName(obj.name);
      const fmeta = document.createElement('div'); fmeta.className='fmeta'; fmeta.textContent = `${parseUploaderFromName(obj.name)} • ${formatDate(obj.updated_at || obj.created_at)} • ${humanSize(obj.metadata && obj.metadata.size ? obj.metadata.size : '')}`;
      left.appendChild(fname); left.appendChild(fmeta);
      meta.appendChild(left);

      const right = document.createElement('div');
      const delBtn = document.createElement('button'); delBtn.className='delete'; delBtn.textContent='Delete';
      delBtn.onclick = async () => {
        // confirm modal-like prompt
        const pass = prompt('Enter admin password to delete this file:');
        if(pass === null) return;
        if(pass === ADMIN_PASSWORD){
          try{
            const { error } = await supabase.storage.from(BUCKET).remove([obj.name]);
            if(error) { alert('Delete failed: ' + (error.message||JSON.stringify(error))); console.error(error); }
            else { alert('Deleted'); renderGallery(); }
          } catch(e){ console.error(e); alert('Delete error'); }
        } else alert('Wrong password');
      };
      right.appendChild(delBtn);
      meta.appendChild(right);
      card.appendChild(meta);
      gallery.appendChild(card);
    }catch(e){ console.error('Render err', e); }
  }
}

/* ---------- Uploader names list (unique) ---------- */
async function renderUploaderList(){
  const listDiv = document.getElementById('uploaderList');
  listDiv.innerHTML = `<div style="color:var(--muted)">Loading uploaders...</div>`;
  const objs = await listAllObjects();
  const names = new Set();
  for(const o of objs){
    const u = parseUploaderFromName(o.name); if(u) names.add(u);
  }
  listDiv.innerHTML = '';
  if(names.size===0){ listDiv.innerHTML = `<div style="color:var(--muted)">No uploaders yet</div>`; return; }
  Array.from(names).sort().forEach(n => {
    const el = document.createElement('div'); el.className='u-item'; el.textContent = n;
    el.onclick = ()=> { galleryFilterUploader = n; setTab('all'); /* show all filtered by uploader */ };
    listDiv.appendChild(el);
  });
}

/* ---------- Init & loader ---------- */
setTab('all'); // initial tab

// showing loader for exactly 3s while trying autoplay during loader
function hideLoaderAndRender(){
  document.getElementById('loader').style.display='none';
  renderGallery();
}

// call later after attempts to autoplay
setTimeout(()=> {
  hideLoaderAndRender();
}, 3000);

/* Small parallax for bg */
(function(){
  const bg = document.querySelector('.bg-grid');
  window.addEventListener('mousemove', e=> {
    const cw = window.innerWidth, ch = window.innerHeight;
    const tx = (e.clientX - cw/2) / (cw/2);
    const ty = (e.clientY - ch/2) / (ch/2);
    const rx = tx * 8, ry = ty * 6;
    bg.style.transform = `translate3d(${rx}px, ${ry}px, 0)`;
  });
})();

/* -------------------- Audio & autoplay (attempt during loader) -------------------- */
const MUSIC_SRC = "https://files.catbox.moe/6rg98h.mp3";
let audioEl = null;
let isPlaying = false;
let audioContext = null;
let audioSource = null;

// create simple audio element (fallback & visible control via button)
function createAudioElement(){
  if(audioEl) return;
  audioEl = document.createElement('audio');
  audioEl.src = MUSIC_SRC;
  audioEl.loop = true;
  audioEl.preload = 'auto';
  audioEl.crossOrigin = "anonymous";
  audioEl.volume = 0.25;
  audioEl.style.display = 'none';
  audioEl.addEventListener('play', ()=> { isPlaying = true; updateMusicBtn(); });
  audioEl.addEventListener('pause', ()=> { isPlaying = false; updateMusicBtn(); });
  document.body.appendChild(audioEl);
}

// try classic audio.play()
async function tryPlayAudioElement(){
  createAudioElement();
  try{
    await audioEl.play();
    isPlaying = true;
    updateMusicBtn();
    return true;
  }catch(e){
    // blocked
    isPlaying = false;
    updateMusicBtn();
    return false;
  }
}

// attempt to prime/resume WebAudio context which sometimes helps autoplay on some Chrome builds
async function tryAudioContextResume(){
  if(typeof AudioContext === 'undefined' && typeof webkitAudioContext === 'undefined') return false;
  try{
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    // quick fetch+decode to prime the audio (may be blocked in some browsers)
    const response = await fetch(MUSIC_SRC, {mode:'cors'});
    const arrayBuffer = await response.arrayBuffer();
    const buffer = await audioContext.decodeAudioData(arrayBuffer.slice(0));
    // create source & connect to destination with gain
    audioSource = audioContext.createBufferSource();
    const gain = audioContext.createGain();
    gain.gain.value = 0.25;
    audioSource.buffer = buffer;
    audioSource.loop = true;
    audioSource.connect(gain);
    gain.connect(audioContext.destination);
    audioSource.start(0);
    isPlaying = true;
    updateMusicBtn();
    return true;
  }catch(err){
    // cleanup if failed
    try{ if(audioSource) audioSource.disconnect(); }catch(e){}
    try{ if(audioContext) audioContext.close(); }catch(e){}
    audioSource = null; audioContext = null;
    return false;
  }
}

// unified attempt: first AudioContext approach (if allowed), then normal audio element
async function attemptAutoplayDuringLoader(){
  // First attempt: try resume AudioContext (some browsers allow)
  const ctxOk = await tryAudioContextResume();
  if(ctxOk) return;
  // second attempt: try playing normal audio element
  await tryPlayAudioElement();
}

// toggle music (user control)
function toggleMusic(){
  createAudioElement();
  if(audioContext && audioSource){
    // if playing via AudioContext: stop it and clear; or start if stopped
    if(isPlaying){
      try{ audioSource.stop(); }catch(e){}
      audioSource = null;
      try{ audioContext.close(); }catch(e){}
      audioContext = null;
      isPlaying = false;
    } else {
      // attempt to restart via AudioContext decode (may be blocked)
      tryAudioContextResume();
    }
    updateMusicBtn();
    return;
  }

  if(audioEl){
    if(audioEl.paused) audioEl.play().catch(()=>{});
    else audioEl.pause();
  } else {
    createAudioElement();
    audioEl.play().catch(()=>{});
  }
}

function updateMusicBtn(){
  const btn = document.getElementById('musicBtn');
  if(!btn) return;
  if(isPlaying) btn.textContent = 'Mute';
  else btn.textContent = 'Play';
}

// try autoplay right away (during loader) — best-effort
window.addEventListener('load', ()=>{
  // Start autoplay attempts immediately while loader is visible
  attemptAutoplayDuringLoader().then(()=> {
    updateMusicBtn();
  }).catch(()=> { updateMusicBtn(); });

  // If autoplay is blocked, play on first user interaction
  document.addEventListener('click', userStartAudio, { once:true, passive:true });
  document.addEventListener('keydown', userStartAudio, { once:true, passive:true });
});

// user gesture handler to ensure audio plays if blocked
function userStartAudio(){
  // if AudioContext exists but suspended, resume it
  if(audioContext && audioContext.state === 'suspended'){
    audioContext.resume().then(()=> { isPlaying = true; updateMusicBtn(); }).catch(()=>{});
    return;
  }
  // else ensure audio element plays
  createAudioElement();
  if(audioEl.paused){
    audioEl.play().then(()=>{ isPlaying = true; updateMusicBtn(); }).catch(()=>{});
  }
}

/* Accessibility: allow Enter key on musicBtn to act */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && document.activeElement && document.activeElement.id === 'musicBtn'){
    toggleMusic();
  }
});

</script>

</body>
</html>
